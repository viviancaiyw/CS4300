{% extends "base.html" %}
{% block content %}
<div class="container">
    <div class="row justify-content-md-center">
        <div class="col-12">
            <div class="placeholder"></div>
            <div class="placeholder"></div>
            <h1 class="display-2 text-white search-title">NEXTGAME</h1>
            <p class="text-white-50 lead">&nbsp;Find your next favorite game via books/movies/games you enjoy. Apply
                tags to further adjust to your quirks. <strong>Steam games only.</strong></p>
            <div class="placeholder"></div>
            <div class="card search-card">
                <div class="card-body">
                    <div class="row justify-content-md-center">
                        <div class="col-11">
                            <form id="search-form" action="/search" method="post" accept-charset="utf-8">
                                <div class="row search-card-row">
                                    <div class="col-2">
                                        <span><strong>PLAYERS: </strong></span>
                                    </div>

                                    <div class="col-3">
                                        <input class="form-check-input" type="checkbox" name="playerTypeSingle"
                                            id="playerTypeSingle" checked>
                                        <label class="form-check-label" for="playerTypeSingle">
                                            <i class="bi bi-person-fill text-primary"></i> single-player
                                        </label>
                                    </div>
                                    <div class="col-3">
                                        <input class="form-check-input" type="checkbox" name="playerTypeMulti"
                                            id="playerTypeMulti" checked>
                                        <label class="form-check-label" for="playerTypeMulti">
                                            <i class="bi bi-people-fill text-primary"></i> multi-player
                                        </label>
                                    </div>
                                </div>

                                <div class="row search-card-row">
                                    <div class="col-2">
                                        <span><i class="bi bi-ui-checks"></i> <strong>GENRE: </strong></span>
                                    </div>
                                    <div class="col-10">
                                        <input class="search-tag-input" id="gameGenre" name="gameGenre"
                                            aria-describedby="genreHelp">
                                        <small id="genreHelp" class="form-text text-muted">Enter <b>game</b> genres you
                                            are interested in</small>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-auto">
                                        <strong>PIECES YOU ENJOY: </strong></span>
                                    </div>
                                </div>

                                <div class="precision-placeholder"></div>

                                <div class="row">
                                    <div class="col-2">
                                        <label for="booksEnjoy" class="form-label"><i
                                                class="bi bi-book text-primary"></i> Book</label>
                                    </div>
                                    <div class="col-10">
                                        <input type="text" disabled id="booksEnjoy" class="form-control"
                                            placeholder="Not Supported Yet">
                                    </div>
                                </div>

                                <div class="precision-placeholder"></div>

                                <div class="row">
                                    <div class="col-2">
                                        <label for="movieEnjoy" class="form-label"><i
                                                class="bi bi-tv text-primary"></i> Movie</label>
                                    </div>
                                    <div class="col-10">
                                        <input class="search-tag-input" id="movieEnjoy" name="movieEnjoy">
                                    </div>
                                </div>

                                <div class="precision-placeholder"></div>

                                <div class="row">
                                    <div class="col-2">
                                        <label for="gamesEnjoy" class="form-label"><i
                                                class="bi bi-suit-spade text-primary"></i> Game</label>
                                    </div>
                                    <div class="col-10">
                                        <input type="text" disabled id="gamesEnjoy" class="form-control"
                                            placeholder="Not Supported Yet">
                                    </div>
                                </div>


                                <div class="row search-card-row">
                                    <div class="col-2">
                                    </div>
                                    <div class="col-10">
                                        <small class="form-text text-muted">We will recommend you games based on
                                            books/movies/games you already enjoy.</b></small>
                                    </div>
                                </div>

                                <div class="row search-card-row">
                                    <div class="col-2">
                                        <strong><i class="bi bi-tags-fill"></i> TAGS: </strong></span>
                                    </div>
                                    <div class="col-10">
                                        <input class="search-tag-input" name="gameTags" id="gameTags"
                                            aria-describedby="tagHelp">
                                        <small id="tagHelp" class="form-text text-muted">Enter other random traits you
                                            want your game to have. <b>Supports up to tags with 5 words.</b></small>
                                    </div>
                                </div>

                                <button type="submit" class="btn btn-primary">Submit</button>

                            </form>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<!-- <form class="form-inline global-search">
    {% if data %}
        <h1>{{output_message}}</h1>
        {% for d in data %}
            <br>
            <p>{{d}}</p>
        {% endfor %}
    {% endif %}
    </form> -->
{% endblock %}

{% block script %}
<script>
    /*
     * Parses form data into the following format:
     * {
     * 'playerTypeSingle': Bool (true = selected, false = not selected)
     * 'playerTypeMulti': Bool
     * 'gameGenre': [String] (list of genres in input)
     * 'movieEnjoy': String (movie id)
     * 'gameTags': [String] (list of tags)
     * }
     */
    $('#search-form').submit(function(e) {
        $("#playerTypeSingle").val($('#playerTypeSingle').is(":checked"));
        $("#playerTypeMulti").val($('#playerTypeMulti').is(":checked"));
        if($("#playerTypeMulti").val() === "false" && $("#playerTypeSingle").val() === "false") {
            formIncompleteAlert("Check at least multiplayer or single player!");
            e.preventDefault();
            return;
        }
        if($("#gameGenre").val() === "" && $("#movieEnjoy").val() === "" && $("#gameTags").val() === "") {
            formIncompleteAlert("Please don't leave everything blank : (");
            e.preventDefault();
            return;
        }
        if($("#gameGenre").val() !== "") {
            $("#gameGenre").val(JSON.stringify(JSON.parse($("#gameGenre").val()).map(x => x.value)));
        }
        if($("#movieEnjoy").val() !== "") {
            $("#movieEnjoy").val(JSON.parse($("#movieEnjoy").val()).map(x => x.value)[0]);
        }
        if($("#gameTags").val() !== "") {
            $("#gameTags").val(JSON.stringify(JSON.parse($("#gameTags").val()).map(x => x.value)));
        }        
    });

    function formIncompleteAlert(custom="") {
        alert("Please compelte the form before submitting!\n" + custom);
    }

    let genres = ['adventure', 'action', 'arena', 'moba', 'real-time-strategy'];
    let genreInput = document.querySelector('input[id=gameGenre]');
    let genreTagify = new Tagify(genreInput, {
        enforceWhitelist: true,
        whitelist: genres,
        dropdown: {
            classname: "color-blue",
            enabled: 0,
            highlightFirst: true
        },
        editTags: false,
        templates: {
            dropdownItemNoMatch: function (data) {
                return `
                    No suggestion found, please enter valid items only.
                `
            }
        }
    });

    let movies = ['Harry Potter', 'Forest Gump', 'Star Wars', 'Avengers', 'A Very Long Movie Name'];
    let movieInput = document.querySelector('input[id=movieEnjoy]');
    let movieTagify = new Tagify(movieInput, {
        mode: 'select',
        whitelist: movies,
        dropdown: {
            classname: "color-blue",
            enabled: 0,
            highlightFirst: true
        },
        templates: {
            dropdownItemNoMatch: function (data) {
                return `
                    No suggestion found, please enter valid items only.
                `
            }
        }
    });
    movieTagify.on('add', onMovieAdd);
    function onMovieAdd(e) {
        if (!movies.includes(e.detail.data.value)) {
            movieTagify.removeAllTags();
        }
    }
    let tagInput = document.querySelector('input[id=gameTags]');
    let tagTagify = new Tagify(tagInput, {
        pattern: /^(?:\b\w+\b[\s\r\n]*){1,5}$/,
        transformTag: transformTag,
    });


    function transformTag(tagData) {
        tagData.value = tagData.value.replace(/  +/g, ' ');;
    }

</script>
{% endblock %}