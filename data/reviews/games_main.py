import download_reviews
from processing import *

import json
import pathlib
import os
import os.path

info_path = 'info/'


# 0-1500
app_ids = [730, 570, 578080, 271590, 440, 359550, 4000, 105600, 304930, 292030, 230410, 252490, 252950, 346110, 1085660, 218620, 444090, 381210, 550, 227300, 413150, 945360, 1097150, 431960, 433850, 221100, 291550, 236390, 242760, 620, 582010, 49520, 238960, 239140, 698780, 319630, 374320, 275850, 322330, 377160, 264710, 227940, 107410, 391540, 301520, 261550, 8930, 203160, 1174180, 976730, 367520, 255710, 250900, 251570, 10, 48700, 755790, 435150, 289070, 322170, 1046930, 477160, 379720, 222880, 22380, 220, 632360, 304050, 394360, 8870, 427520, 386360, 814380, 550650, 812140, 294100, 244850, 262060, 306130, 211820, 221380, 782330, 438100, 552520, 646570, 219740, 391220, 220200, 552990, 629760, 232090, 281990, 365590, 466240, 400, 291480, 305620, 225540, 648800, 1289310, 203770, 224260, 901583, 12210, 333930, 220240, 218230, 361420, 236850, 444200, 504370, 268910, 282070, 363970, 594650, 424370, 594570, 387990, 588650, 813780, 20920, 1172380, 582160, 489520, 211420, 524220, 204360, 489830, 304390, 457140, 270880, 206420, 883710, 674940, 20900, 379430, 219150, 311690, 644560, 219990, 219640, 518790, 323190, 581320, 359320, 393380, 346900, 433340, 383870, 813820, 212680, 223470, 238460, 284160, 548430, 438740, 12120, 231430, 552500, 1145360, 265930, 362890, 447040, 286690, 779340, 440900, 233450, 397900, 205100, 331470, 268500, 241930, 397540, 1089350, 70, 460930, 238320, 3590, 311210, 55230, 508440, 588430, 620980, 273110, 1172620, 261570, 287700, 386180, 206440, 200210, 113200, 513710, 242050, 335300, 113400, 208650, 356190, 1057090, 1250, 960090, 493340, 239030, 221910, 414340, 287390, 8190, 346010, 546560, 213670, 1281930, 387290, 234140, 214950, 253710, 274190, 555570, 233860, 834910, 246620, 207610, 611500, 225080, 844870, 239820, 200510, 417860, 109600, 242920, 683320, 223710, 750920, 648350, 280790, 307690, 703080, 214490, 24960, 613100, 412020, 601150, 302830, 617290, 298110, 884660, 582660, 364360, 418460, 244210, 636480, 554620, 274170, 200710, 645630, 1113000, 204100, 787860, 201810, 10090, 644930, 243470, 389730, 349040, 289650, 1237970, 313120, 204300, 240720, 376210, 17390, 976310, 253230, 50130, 460950, 838350, 242860, 646910, 1151640, 39210, 516750, 601510, 752590, 334230, 236430, 33230, 466560, 107100, 237930, 504230, 355840, 108600, 105450, 380600, 761890, 304430, 570940, 200260, 637650, 203140, 108710, 994280, 431240, 299740, 261640, 307780, 848450, 632470, 22370, 526870, 17410, 955050, 250600, 393420, 952060, 745920, 201270, 236870, 337000, 99900, 774171, 403640, 418370, 274940, 286160, 35450, 621060, 666140, 312660, 285900, 282140, 50300, 480490, 8500, 22330, 900883, 657200, 638970, 47890, 104900, 360430, 250320, 257510, 678950, 40800, 583950, 630, 871720, 1158310, 383120, 447530, 470220, 261030, 221040, 254700, 263280, 553640, 1217060, 10180, 244450, 736190, 319510, 815370, 248820, 24240, 339800, 310560, 372000, 35140, 302510, 326460, 48000, 269210, 434570, 7670, 209000, 863550, 692850, 236110, 668630, 226700, 335240, 557340, 333600, 110800, 532210, 32370, 942970, 903950, 1190460, 247080, 391460, 544920, 1189630, 414700, 686810, 312990, 8980, 207140, 323370, 371660, 476600, 312530, 728880, 678960, 314160, 447820, 266840, 485510, 228380, 365670, 325610, 47870, 420530, 420, 880940, 41070, 424280, 501300, 367500, 260230, 221640, 447020, 418240, 454650, 238010, 262410, 751780, 322500, 235460, 384190, 310950, 24200, 32470, 299360, 39140, 1100600, 42910, 444640, 893520, 33930, 841370, 555160, 1250410, 475150, 881100, 744900, 674020, 420290, 577800, 535930, 383080, 612880, 640820, 459820, 259080, 675010, 317400, 1213210, 368500, 882100, 248570, 460920, 569480, 406150, 394510, 238090, 823500, 373420, 1118200, 434650, 12110, 241600, 288160, 324800, 4500, 637090, 630100, 374040, 386940, 4700, 489940, 578310, 250400, 9900, 438040, 21690, 57300, 714010, 582500, 303210, 629520, 625960, 241560, 474960, 544810, 212070, 493520, 383980, 223750, 427730, 208580, 245170, 859580, 1222140, 766570, 35720, 495420, 17460, 599140, 488790, 905370, 475550, 298630, 11020, 287290, 1118010, 211500, 563560, 24010, 224600, 233130, 851850, 413410, 424840, 80, 22300, 939960, 460790, 375230, 552100, 706990, 901242, 24980, 330830, 236090, 239160, 738060, 235600, 244930, 41700, 385800, 289130, 895400, 502500, 270550, 264200, 344760, 65980, 584400, 389570, 233720, 232430, 212500, 323850, 10500, 39000, 1151340, 323470, 214560, 235540, 206210, 1094520, 12200, 824270, 1286830, 47810, 629730, 239350, 641990, 991780, 392110, 220440, 356670, 351640, 233270, 204450, 313340, 22320, 102500, 626690, 550900, 1089980, 202970, 257850, 47780, 278360, 603850, 527230, 365360, 428690, 517630, 548570, 573090, 928600, 332310, 17470, 291650, 505460, 453480, 967050, 237990, 530700, 250760, 219890, 242720, 256290, 268050, 283640, 365450, 339610, 201790, 313160, 677620, 413420, 794260, 282800, 492720, 7940, 495890, 39120, 425580, 1046030, 493900, 812810, 589290, 1097840, 48190, 858810, 251060, 230290, 301640, 992300, 962130, 285190, 242680, 292730, 206500, 48240, 202170, 384300, 418340, 760060, 285920, 442080, 736260, 320300, 736220, 402710, 9200, 367450, 248390, 34870, 292120, 35700, 17300, 653530, 364470, 10680, 536220, 71340, 282900, 391720, 4760, 427290, 464920, 389430, 606880, 445980, 601430, 337320, 602520, 265300, 568220, 773951, 306460, 473690, 673950, 529180, 365300, 955900, 332800, 590380, 368360, 690790, 359870, 962730, 388410, 519860, 481510, 420110, 1284410, 294860, 297000, 290340, 512900, 527430, 503560, 977950, 704270, 335670, 311340, 206190, 214420, 436520, 224760, 209650, 15100, 211400, 409160, 394690, 337340, 209160, 642250, 269950, 448510, 238430, 471710, 973760, 866800, 245620, 1102190, 933480, 298240, 65800, 249130, 753640, 429660, 19900, 209080, 268420, 412830, 210970, 378860, 405640, 571740, 411300, 311730, 201870, 250820, 47410, 8850, 368340, 304240, 223100, 6000, 1128000, 246900, 228300, 704850, 519190, 498240, 234650, 423880, 341940, 311560, 1022450, 242700, 451340, 12900, 48720, 34030, 774861, 32440, 290080, 635260, 446800, 555220, 221680, 225260, 633230, 996470, 233290, 960170, 1128810, 2600, 212480, 265550, 42960, 712100, 368070, 449960, 1066780, 70000, 732430, 360170, 652980, 851100, 6020, 6910, 350080, 392160, 237310, 450540, 950670, 567640, 351290, 215280, 386070, 204880, 249050, 531510, 805550, 50, 234630, 1222680, 282660, 383150, 494840, 342200, 228280, 226860, 597170, 20510, 253250, 375950, 400910, 4920, 17450, 215080, 560130, 360940, 1162520, 266510, 953490, 244160, 224580, 214340, 216150, 9480, 234670, 287450, 17480, 985890, 774361, 50620, 879160, 213610, 666220, 57690, 17520, 396750, 428550, 611790, 302670, 96100, 115300, 728540, 367580, 394310, 278080, 872410, 6860, 42700, 1080110, 210770, 341800, 787480, 533300, 606150, 300380, 108800, 462780, 823130, 287980, 641320, 304030, 288470, 362960, 40970, 627690, 359050, 224480, 274520, 212800, 34900, 22350, 266010, 638230, 388090, 1147560, 421020, 914620, 443810, 557600, 55150, 9450, 270150, 329110, 445220, 382490, 1021950, 415200, 606280, 378648, 493490, 558100, 464060, 388880, 212160, 232890, 204340, 248610, 38400, 537180, 237870, 418030, 403190, 12100, 605740, 45760, 491950, 401920, 329430, 2280, 38410, 773920, 362680, 977400, 258520, 430960, 816020, 48220, 700030, 272060, 609320, 665360, 301910, 291860, 208140, 552620, 311310, 474750, 333420, 682990, 707010, 329050, 263980, 1180380, 859570, 290300, 330020, 385760, 535230, 304650, 397340, 238370, 784150, 1237950, 245470, 537800, 397950, 39150, 731490, 268650, 616560, 1049800, 778700, 215530, 1238810, 20500, 21090, 531640, 506610, 429790, 743450, 296300, 436150, 306020, 362490, 690830, 462770, 496300, 40700, 593600, 274920, 1056960, 130, 627270, 723780, 115320, 232810, 226840, 469820, 362930, 227860, 327410, 10150, 437920, 242640, 286100, 351970, 602960, 578620, 423230, 320, 813630, 690530, 742120, 843380, 559650, 969990, 1126290, 253430, 218680, 435400, 280160, 17430, 1056640, 218640, 328080, 264140, 530070, 223850, 350640, 268750, 377840, 298610, 361280, 324810, 562220, 319910, 870780, 410900, 361800, 633460, 792220, 730310, 767560, 320240, 354140, 1127400, 276810, 368230, 70400, 496240, 49540, 446020, 12140, 433950, 604240, 368370, 635730, 378610, 40100, 360740, 584980, 204030, 541570, 9420, 564710, 544730, 861650, 17570, 331600, 387860, 246420, 251990, 1161580, 1150080, 643270, 71250, 374280, 356570, 63380, 996580, 56437, 1064610, 268130, 67370, 298050, 26800, 342180, 622650, 222940, 39510, 1214280, 518030, 589360, 1264670, 965200, 346120, 597220, 258970, 24780, 94400, 601840, 456750, 939400, 240320, 710920, 352520, 1283220, 239200, 410320, 598700, 215470, 404410, 252330, 272510, 332950, 581630, 526160, 333950, 225600, 91700, 667530, 296470, 1147690, 378540, 921630, 392950, 222480, 701160, 465520, 250180, 788100, 544750, 738520, 753420, 228200, 65540, 290930, 102600, 2100, 230190, 235800, 70300, 295790, 502520, 232010, 835860, 257350, 236690, 1178490, 690640, 530890, 589780, 1017900, 783770, 719040, 395170, 1148650, 219830, 1240210, 575640, 610080, 509980, 466910, 435030, 251150, 39500, 570660, 508900, 673880, 240760, 1044200, 562810, 503940, 840800, 528230, 321360, 316790, 422970, 369990, 327890, 234080, 515180, 1226470, 705220, 233610, 1049890, 233980, 429050, 363150, 281610, 221260, 232910, 921570, 573100, 678800, 378649, 486310, 499520, 909080, 671510, 399810, 332500, 607890, 487120, 439350, 208200, 1170880, 310080, 238210, 707030, 656350, 40950, 293260, 614570, 1291340, 1136160, 795100, 764790, 1064220, 41000, 954740, 317470, 233470, 788260, 450390, 332070, 816090, 617810, 363680, 297130, 202750, 65930, 15620, 378370, 231160, 533540, 1238860, 252610, 375910, 834530, 882790, 1258080, 21100, 222730, 745880, 293760, 57900, 351940, 321960, 285310, 206480, 351920, 237630, 429570, 9010, 104200, 356040, 847370, 900270, 321300, 619150, 921060, 712840, 380840, 382310, 530620, 263760, 32430, 952860, 25890, 513510, 373930, 462930, 1167450, 327070, 931690, 28000, 236370, 269770, 337950, 637850, 307880, 496460, 377530, 300550, 9050, 352720, 459220, 572410, 243970, 617830, 250620, 939510, 1030830, 40300, 362620, 242550, 304212, 366090, 40990, 302590, 451020, 1178030, 587620, 728530, 232790, 758190, 675260, 1144400, 606800, 585420, 737800, 861540, 398710, 339600, 235380, 1055540, 311260, 611670, 1070710, 456670, 746850, 467960, 718670, 1238840, 270170, 1016920, 280740, 224460, 927380, 866440, 446150, 665180, 215830, 24790, 424030, 22100, 217200, 234330, 893180, 794600, 375480, 588040, 654880, 431730, 1241100, 4580, 690510, 286080, 384180, 232770, 677120, 250260, 1104450, 593280, 1121560, 499440, 1115690, 686200, 293780, 200170, 1067310, 332570, 2630, 514900, 363890, 1061090, 673610, 521890, 245280, 495910, 228180, 2700, 207170, 426000, 363930, 427100, 458710, 41500, 667890, 435530, 1209040, 502800, 20, 2310, 236450, 4570, 331360, 939850, 479130, 711810, 632350, 265890, 214510, 899440, 355880, 660880, 460810, 327030, 803330, 274900, 807120, 24720, 270850, 658850, 637100, 214730, 4560, 546050, 25000, 353560, 384490, 324080, 332200, 1108320, 2300, 341000, 324160, 586140, 911400, 1214420, 200900, 1146630, 506140, 265210, 463530, 992310, 314650, 220780, 421040, 9880, 670290, 34270, 702670, 512470, 1116960, 570840, 386880, 326480, 973580, 32500, 681280, 862690, 264380, 595520, 42670, 239070, 307960, 470310, 238260, 301860, 1089090, 644830, 897330, 523780, 263500, 520440, 407130, 511680, 259680, 277430, 994730, 220260, 840260, 1012880, 1007040, 589870, 690040, 11450, 289950, 1256670, 18500, 575550, 339340, 1184050, 250340, 1158980, 972660, 414530, 12150, 3920, 636040, 449540, 212630, 1122720, 511470, 252410, 562010, 732690, 505230, 315460, 865360, 247000, 287630, 7520, 785740, 248860, 720280, 878380, 260430, 323320, 617670, 34830, 480430, 704450, 98400, 241260, 252530, 769560, 589590, 1106840, 404680, 269790, 1222700, 45740, 247020]

def extract_single_game(app_id):
	print("app_id:", app_id)
	# Download reviews.
	print("Download reviews")
	reviews_dict = download_reviews.get_reviews(app_id)

	# Filter review dict (recommendationid -> review info).
	reviews_dict = filter_reviews_dict(reviews_dict)

	# Look at only 'review' text.
	reviews = [r['review'] for r in reviews_dict.values()]

	# Clean reviews.
	print("Clean reviews")
	reviews = list(map(clean_review, reviews))
	reviews = list(filter(lambda x: x!='', reviews))

	# Tranform reviews.
	print("Transform reviews")
	transformed_reviews = list(map(transform_and_remove_words, reviews))
	transformed_reviews = list(filter(lambda x: x!='', transformed_reviews))

	# Extract keyphrases from original reviews.
	print("Keyphrases")
	keyphrases = extract_keyphrases(reviews)

	# Extract keywords from cleaned reviews.
	print("Keywords")
	keywords = extract_keywords(transformed_reviews)
	print(keywords[:10])
	print(keyphrases[:5])

	return keyphrases, keywords

def write_info(info, app_id):
	pathlib.Path(info_path).mkdir(parents=True, exist_ok=True)
	output_path = info_path+'info_'+str(app_id)+'.json'

	with open(output_path, 'w') as f:
		f.write(json.dumps(info)+'\n')

def write_total(keyphrases, keywords, keyphrases_dict, tfidf_dict, count_dict):
	total = {'keyphrases':keyphrases, 'keywords':keywords}

	output_path = 'keyphrases_and_keywords.json'
	with open(output_path, 'w') as f:
		f.write(json.dumps(total, indent=4)+'\n')

	output_path = 'keyphrases_dict.json'
	with open(output_path, 'w') as f:
		f.write(json.dumps(keyphrases_dict, indent=4)+'\n')

	output_path = 'keywords_tfidf_dict.json'
	with open(output_path, 'w') as f:
		f.write(json.dumps(tfidf_dict, indent=4)+'\n')	

	output_path = 'keywords_count_dict.json'
	with open(output_path, 'w') as f:
		f.write(json.dumps(count_dict, indent=4)+'\n')	

def extract_common():
	all_keywords = list()
	all_keyphrases = list()
	count = 0
	for filename in os.listdir(info_path):
		if filename.endswith('.json'):
			with open(info_path+filename, 'r', encoding='utf8') as in_json_file:
				print("Process file", filename)
				info = json.load(in_json_file)
				all_keywords.append(" ".join(info['keywords']))
				all_keyphrases.extend(info['keyphrases'])

	keyphrases, keywords, keyphrases_dict, tfidf_dict, count_dict = extract_common_keywords_and_phrases(all_keywords, all_keyphrases)
	return keyphrases, keywords, keyphrases_dict, tfidf_dict, count_dict


if __name__ == "__main__":
	# for app_id in app_ids:
	# 	app_id = str(app_id)
	# 	output_path = info_path+'info_'+str(app_id)+'.json'
	# 	if os.path.isfile(output_path):
	# 		print(app_id," exists")
	# 		continue

	# 	keyphrases, keywords = extract_single_game(app_id)
	# 	info = {'app_id':app_id, 'keyphrases':keyphrases, 'keywords': keywords}

	# 	write_info(info, app_id)

	# keyphrases, keywords, keyphrases_dict, tfidf_dict, count_dict = extract_common()
	# write_total(keyphrases, keywords, keyphrases_dict, tfidf_dict, count_dict)

	inverse_idx = dict()

	for filename in os.listdir(info_path):
		if filename.endswith('.json'):
			with open(info_path+filename, 'r', encoding='utf8') as in_json_file:
				print("Process file", filename)
				info = json.load(in_json_file)
				app_id = info['app_id']

				print("Keywords")
				for keyword in info['keywords']:
					lst = inverse_idx.get(keyword, list())
					lst.append(app_id)
					inverse_idx[keyword] = lst

				print("Keyphrases")
				for keyphrase in info['keyphrases']:
					lst = inverse_idx.get(keyphrase, list())
					lst.append(app_id)
					inverse_idx[keyphrase] = lst


	output_path = 'inverse_keyword_phrases.json'
	with open(output_path, 'w') as f:
		f.write(json.dumps(inverse_idx, indent=4)+'\n')
